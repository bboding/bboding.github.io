name: release

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Set envs
        run: |
          echo '::set-env name=DOCKER_REPO::doublencinc/ncnc-scripts'
      - name: action-slack
        uses: 8398a7/action-slack@v3.5.0
        with:
          status: custom
          custom_payload: |
            {
              text: "릴리즈를 시작합니다.",
              attachments: [{
                color: 'good',
                fields: [{
                  title: 'Repo',
                  value: '${{github.repository}}',
                  short: true
                },
                {
                  title: 'Version',
                  value: '${{github.event.release.tag_name}}',
                  short: true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{secrets.SLACK_WEBHOOK_URL}}
      - name: Checkout
        uses: actions/checkout@v2.3.1
      - name: Build and push Docker images
        run: |
          docker build --network host --build-arg GITHUB_PAT=${{ secrets.GH_PAT }} -t $DOCKER_REPO:${{github.event.release.tag_name}} .
          docker push $DOCKER_REPO:${{github.event.release.tag_name}}
      - name: Apply Terraform
        run: |
          cd terraform
          terraform init
          terraform apply -auto-approve -var 'app_version=${{github.event.release.tag_name}}'
      - name: action-slack
        uses: 8398a7/action-slack@v3.5.0
        with:
          status: custom
          custom_payload: |
            {
              text: "릴리즈가 완료되었습니다! 🚀🚀",
              attachments: [{
                color: 'good',
                fields: [{
                  title: 'Repo',
                  value: '${{github.repository}}',
                  short: true
                },
                {
                  title: 'Version',
                  value: '${{github.event.release.tag_name}}',
                  short: true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{secrets.SLACK_WEBHOOK_URL}}
